
package net.myfigurecollection;

import java.io.File;
import java.io.IOException;

import net.myfigurecollection.android.FigureListFragment;
import net.myfigurecollection.android.FigureListFragment.OnFigureSelectedListener;
import net.myfigurecollection.android.FigureViewerFragment.OnFigureViewListener;
import net.myfigurecollection.android.data.XMLHandler;
import net.myfigurecollection.android.data.objects.Figure;
import net.myfigurecollection.android.webservices.MFCService;
import net.myfigurecollection.android.webservices.RequestListener;
import Utils.Constants;
import android.content.Context;
import android.content.Intent;
import android.content.res.Configuration;
import android.graphics.Bitmap;
import android.os.Build;
import android.os.Bundle;
import android.os.Environment;
import android.provider.MediaStore;
import android.support.v4.app.Fragment;
import android.support.v4.app.FragmentManager;
import android.support.v4.app.FragmentStatePagerAdapter;
import android.support.v4.view.ViewPager;
import android.support.v4.view.ViewPager.OnPageChangeListener;
import android.util.Log;
import android.view.Display;
import android.view.View;
import android.view.WindowManager;
import android.webkit.WebSettings;
import android.webkit.WebView;
import android.webkit.WebViewClient;
import android.widget.ArrayAdapter;
import android.widget.LinearLayout;

import com.actionbarsherlock.app.ActionBar;
import com.actionbarsherlock.app.ActionBar.OnNavigationListener;
import com.actionbarsherlock.app.SherlockFragmentActivity;
import com.actionbarsherlock.view.Menu;
import com.actionbarsherlock.view.MenuItem;
import com.actionbarsherlock.view.Window;
import com.androidquery.util.AQUtility;
import com.viewpagerindicator.PageIndicator;
import com.viewpagerindicator.TitlePageIndicator;
import com.viewpagerindicator.TitlePageIndicator.IndicatorStyle;
import com.viewpagerindicator.TitleProvider;

public class MFCApp2Activity extends SherlockFragmentActivity implements OnFigureSelectedListener, OnFigureViewListener, OnPageChangeListener,
		OnNavigationListener, RequestListener
{

	class TitleFragmentAdapter extends FragmentStatePagerAdapter implements TitleProvider
	{

		public FigureListFragment	leftFrag;
		final int					MARGIN	= 16;
		int							mCount	= 3;
		int							mCurrentTab;

		public TitleFragmentAdapter(FragmentManager fm)
		{
			super(fm);
		}

		@Override
		public int getCount()
		{
			return mCount;
		}

		@Override
		public Fragment getItem(int position)
		{

			leftFrag = FigureListFragment.newInstance(getResources().getColor(R.color.android_green), 1f, MARGIN, MARGIN, MARGIN, MARGIN,
					position, MFCApp2Activity.this);
			return leftFrag;
		}

		@Override
		public String getTitle(int position)
		{
			return getTabTitle(position);
		}

		public void setCount(int count)
		{
			if (count > 0 && count <= 10)
			{
				mCount = count;
				notifyDataSetChanged();
			}
		}

	}

	public class WebClient extends WebViewClient
	{

		@Override
		public void onLoadResource(WebView view, String url)
		{
			super.onLoadResource(view, url);
		}

		@Override
		public void onPageFinished(WebView view, String url)
		{
			super.onPageFinished(view, url);
			OnFigureDetailsFinishedLoading(url);
		}

		@Override
		public void onPageStarted(WebView view, String url, Bitmap favicon)
		{
			super.onPageStarted(view, url, favicon);
			OnFigureDetailsStartedLoading(url);
		}
	}

	static final boolean	IS_HONEYCOMB	= Build.VERSION.SDK_INT >= Build.VERSION_CODES.HONEYCOMB;
	private boolean			isLandscape		= false;

	TitleFragmentAdapter	mAdapter;
	PageIndicator			mIndicator;
	ViewPager				mPager;

	private final boolean	showHomeUp		= false;

	// private FigureListFragment leftFrag;
	private final boolean	useLogo			= false;

	private WebView			viewer;

	@Override
	public void changeValue(int id, String value)
	{
		// TODO Auto-generated method stub
	}

	// @Override
	// public boolean onCreateOptionsMenu(Menu menu) {
	// getMenuInflater().inflate(R.menu.main_menu, menu);
	//
	// // set up a listener for the refresh item
	// refresh = menu.findItem(R.id.menu_refresh);
	// refresh.setOnMenuItemClickListener(new OnMenuItemClickListener() {
	// // on selecting show progress spinner for 1s
	// @Override
	// public boolean onMenuItemClick(MenuItem item) {
	// // item.setActionView(R.layout.progress_action);
	// handler.postDelayed(new Runnable() {
	// @Override
	// public void run() {
	// refresh.setActionView(null);
	// }
	// }, 1000);
	// return false;
	// }
	// });
	// return super.onCreateOptionsMenu(menu);
	// }

	@Override
	public void changeVisibility(int id, int value)
	{
		// TODO Auto-generated method stub
	}

	@SuppressWarnings("unused")
	private void dispatchTakePictureIntent(int actionCode)
	{
		Intent takePictureIntent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE);
		startActivityForResult(takePictureIntent, actionCode);
	}

	public String getTabTitle(int position)
	{

		switch (position) {
			case 0:
				return getString(R.string.cat_wished);
			case 1:
				return getString(R.string.cat_ordered);
			case 2:
				return getString(R.string.cat_owned);
			case 3:
				return getString(R.string.cat_search);

		}

		return null;
	}

	private void loadInterface()
	{
		setContentView(R.layout.main);
		viewer = (WebView) findViewById(R.id.figureView);
		viewer.setWebViewClient(new WebClient());
		WebSettings webSettings = viewer.getSettings();
		webSettings.setJavaScriptEnabled(true);
		webSettings.setBuiltInZoomControls(true);
		viewer.setBackgroundColor(0);

		final ActionBar ab = getSupportActionBar();
		setSupportProgressBarIndeterminateVisibility(false);
		// set defaults for logo & home up
		ab.setDisplayHomeAsUpEnabled(showHomeUp);
		ab.setDisplayUseLogoEnabled(useLogo);

		// set up tabs nav
		// for (int i = 0; i < 3; i++)
		// {
		// ab.addTab(ab.newTab().setText(getTabTitle(i)).setTabListener(this));
		// }

		// showTabsNav();
		mAdapter = new TitleFragmentAdapter(getSupportFragmentManager());
		mPager = (ViewPager) findViewById(R.id.pager);
		mPager.setAdapter(mAdapter);

		TitlePageIndicator indicator = (TitlePageIndicator) findViewById(R.id.indicator);
		indicator.setViewPager(mPager);
		indicator.setOnPageChangeListener(this);
		indicator.setFooterIndicatorStyle(IndicatorStyle.Triangle);
		mIndicator = indicator;

		// mIndicator.setCurrentItem(1);
		// create a couple of simple fragments as placeholders
		// final int MARGIN = 16;
		// leftFrag = new
		// FigureListFragment(getResources().getColor(R.color.android_green),
		// 1f, MARGIN, MARGIN, MARGIN, MARGIN, this);

		// FragmentTransaction ft =
		// getSupportFragmentManager().beginTransaction();
		// ft.replace(R.id.root, leftFrag);
		Display display = ((WindowManager) getSystemService(Context.WINDOW_SERVICE)).getDefaultDisplay();

		isLandscape = display.getWidth() > display.getHeight();
		int lefWidth;

		if (FigureListFragment.isLandscape = isLandscape)
		{
			FigureListFragment.EXPANDED_MODE = View.GONE;
			viewer.setVisibility(View.VISIBLE);
			lefWidth = (int) getResources().getDimension(R.dimen.left_width_landscape);

		} else
		{
			// ft.add(rightFrag, "hidden");
			FigureListFragment.EXPANDED_MODE = View.VISIBLE;
			viewer.setVisibility(View.GONE);
			lefWidth = (int) getResources().getDimension(R.dimen.left_width_portrait);
		}

		((LinearLayout.LayoutParams) findViewById(R.id.subroot).getLayoutParams()).width = lefWidth;
	}

	@Override
	public void onBackPressed()
	{
		FigureListFragment.EXPANDED_MODE = View.VISIBLE;
		if (viewer.getVisibility() == View.VISIBLE)
		{
			viewer.setVisibility(View.GONE);
			// viewer.startAnimation(new SweetScaleAnimation(1.0f, 1.0f, 1.0f,
			// 0.0f, 500, viewer, true));
		}
		else super.onBackPressed();
	}

	@Override
	public void onConfigurationChanged(Configuration newConfig)
	{
		super.onConfigurationChanged(newConfig);
		// setContentView(R.layout.main);
		Display display = ((WindowManager) getSystemService(Context.WINDOW_SERVICE)).getDefaultDisplay();

		isLandscape = display.getWidth() > display.getHeight();

		FigureListFragment.isLandscape = isLandscape;
		int lefWidth;

		if (FigureListFragment.isLandscape = isLandscape)
		{
			lefWidth = (int) getResources().getDimension(R.dimen.left_width_landscape);
			FigureListFragment.EXPANDED_MODE = View.GONE;
			viewer.setVisibility(View.VISIBLE);
		} else
		{
			// ft.add(rightFrag, "hidden");
			FigureListFragment.EXPANDED_MODE = View.VISIBLE;
			viewer.setVisibility(View.GONE);
			lefWidth = (int) getResources().getDimension(R.dimen.left_width_portrait);
		}

		((LinearLayout.LayoutParams) findViewById(R.id.subroot).getLayoutParams()).width = lefWidth;

		mAdapter.notifyDataSetChanged();
	}

	@Override
	public void onContextMenu(int id)
	{
		// startActionMode(mAdapter.leftFrag.getActionMode());
		mAdapter.notifyDataSetChanged();
		Log.d("MFC", "Context");
	}

	/** Called when the activity is first created. */
	@Override
	public void onCreate(Bundle savedInstanceState)
	{
		super.onCreate(savedInstanceState);
		requestWindowFeature(Window.FEATURE_INDETERMINATE_PROGRESS);

		String dir = Environment.getExternalStorageDirectory().getPath() + "/Android/data/" + getPackageName() + "/files/images";

		Log.d("MFCApp2Activity", "cache dir: " + dir);

		final File directory = new File(dir);
		if (Environment.MEDIA_MOUNTED.equals(Environment.getExternalStorageState()))
		{
			// We can read and write the media

			File nomedia = new File(dir + "/.nomedia");
			if (!nomedia.exists())
			{
				try
				{
					directory.mkdirs();
					nomedia.createNewFile();
				}
				catch (IOException e)
				{
					e.printStackTrace();
				}
			}

		}

		AQUtility.setCacheDir(directory);

		loadInterface();

		Context context = getSupportActionBar().getThemedContext();
		ArrayAdapter<CharSequence> list = ArrayAdapter.createFromResource(context, R.array.filters, R.layout.sherlock_spinner_item);
		list.setDropDownViewResource(R.layout.sherlock_spinner_dropdown_item);

		// getSupportActionBar().setNavigationMode(ActionBar.NAVIGATION_MODE_LIST);
		// getSupportActionBar().setListNavigationCallbacks(list, this);

		// TODO:new FigureGalleryCursor(this, "5769", this);

		viewer.loadData(
				"<html><head><style type=\"text/css\">p{color:#FFF;font-weight:bold;text-align:center;vertical-align:middle;}</style></head><body><p>Choose a figure to view its details on MFC</p></body></html>",
				"text/html", "utf-8");
		// ft.commit();
	}

	@Override
	public boolean onCreateOptionsMenu(Menu menu)
	{
		// menu.add("View Details")
		// .setIcon(R.drawable.ic_menu_hide_right)
		// .setShowAsAction(MenuItem.SHOW_AS_ACTION_IF_ROOM |
		// MenuItem.SHOW_AS_ACTION_WITH_TEXT);

		menu.add(getString(R.string.take_picture))
				.setIcon(R.drawable.ic_action_camera)
				.setShowAsAction(MenuItem.SHOW_AS_ACTION_IF_ROOM | MenuItem.SHOW_AS_ACTION_WITH_TEXT);

		menu.add(getString(R.string.refresh))
				.setIcon(R.drawable.ic_action_refresh)
				.setShowAsAction(MenuItem.SHOW_AS_ACTION_IF_ROOM | MenuItem.SHOW_AS_ACTION_WITH_TEXT);

		return super.onCreateOptionsMenu(menu);
	}

	@Override
	public void OnFigureDetailsFinishedLoading(String url)
	{
		setSupportProgressBarIndeterminateVisibility(false);
	}

	@Override
	public void OnfigureDetailsLoading(String url, int percent)
	{
		// TODO Auto-generated method stub
	}

	@Override
	public void OnFigureDetailsStartedLoading(String url)
	{
		setSupportProgressBarIndeterminateVisibility(true);
	}

	@Override
	public void onFigureSelected(String tutUrl)
	{
		if (viewer != null)
		{
			// viewer.startAnimation(new SweetScaleAnimation(0, 50, 0, 50, 300,
			// viewer, false));
			viewer.setVisibility(View.VISIBLE);
			// ((LinearLayout.LayoutParams)viewer.getLayoutParams()).weight =
			// 100;

			viewer.loadUrl(tutUrl);
		}

		mAdapter.notifyDataSetChanged();
	}

	@Override
	public boolean onNavigationItemSelected(int itemPosition, long itemId)
	{
		switch (itemPosition) {
			case 0:
				FigureListFragment.ADDITIONAL_SORTER = "";
				// mAdapter.leftFrag.setNewsCursor(getContentResolver().query(Figure.CONTENT_URI,
				// mAdapter.leftFrag.getProjection(), "status=?", new String[] {
				// ""+curcat },FigureListFragment.ADDITIONAL_SORTER +
				// Figure.NAME + " ASC"));
				break;
			case 1:
				FigureListFragment.ADDITIONAL_SORTER = Figure.CATEGORY + " ASC, ";
				// mAdapter.leftFrag.setNewsCursor(getContentResolver().query(Figure.CONTENT_URI,
				// mAdapter.leftFrag.getProjection(), "status=?", new String[] {
				// ""+curcat },FigureListFragment.ADDITIONAL_SORTER +
				// Figure.NAME + " ASC"));

				break;
			case 2:
				FigureListFragment.ADDITIONAL_SORTER = Figure.MANUFACTURER + " ASC, ";
				// mAdapter.leftFrag.setNewsCursor(getContentResolver().query(Figure.CONTENT_URI,
				// mAdapter.leftFrag.getProjection(), "status=?", new String[] {
				// ""+curcat },FigureListFragment.ADDITIONAL_SORTER +
				// Figure.NAME + " ASC"));
				break;

			default:
				FigureListFragment.ADDITIONAL_SORTER = "";
				break;
		}

		// mAdapter.leftFrag.getNewsCursor().requery();
		mAdapter.notifyDataSetChanged();

		return false;
	}

	@Override
	public boolean onOptionsItemSelected(MenuItem item)
	{
		if (item.getTitle().equals(getString(R.string.refresh)))
		{
			// mAdapter.leftFrag.load(true);
			setSupportProgressBarIndeterminateVisibility(true);
			XMLHandler xmlh = new XMLHandler(this, true);
			xmlh.setListener(this);
			xmlh.execute((Constants.API_MODE_COLLECTION + getSharedPreferences(MFCService.PREFERENCES, Context.MODE_WORLD_WRITEABLE).getString("Login",
					"Kumasanmk")));
		} else if (item.getTitle().equals(getString(R.string.take_picture)))
		{
			// mAdapter.leftFrag.load(true);
			Intent i = new Intent(this, PhotoIntentActivity.class);
			startActivity(i);
		}
		return super.onOptionsItemSelected(item);

	}

	@Override
	public void onPageScrolled(int arg0, float arg1, int arg2)
	{

	}

	@Override
	public void onPageScrollStateChanged(int arg0)
	{

	}

	@Override
	public void onPageSelected(int arg0)
	{
		if (FigureListFragment.mMode != null)
		{
			FigureListFragment.mMode.finish();
		}
		// Toast.makeText(this, "Changed to page " + arg0,
		// Toast.LENGTH_SHORT).show();

	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * net.myfigurecollection.android.webservices.RequestListener#onRequestcompleted
	 * (int, java.lang.Object)
	 */
	@Override
	public void onRequestcompleted(int requestCode, Object result)
	{
		setSupportProgressBarIndeterminateVisibility(false);

	}

	public void updateUrl(String newUrl)
	{
		if (viewer != null)
		{
			viewer.loadUrl(newUrl);
		}
	}

	// public void onJsonReady(JsonCursor cursor)
	// {
	// //TODO:(new AQuery(this)).id(R.id.gallery).adapter(new
	// FigureGalleryAdapter(this, R.id.gallery, cursor));
	// //listAq.id(R.id.gallery).visible();
	// }

}